name: CI/CD AKS Deployment

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  ACR_NAME: kennyacr1
  ACR_LOGIN_SERVER: kennyacr1.azurecr.io

jobs:

  build-and-push:
    runs-on: ubuntu-latest

    steps:

      # Checkout del repositorio
      - name: Checkout repo
        uses: actions/checkout@v3

      # Login en Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Login en ACR
      - name: ACR Login
        run: |
          az acr login --name $ACR_NAME

      # Habilitar Docker Buildx (soporte multi-plataforma)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Build & Push Backend Image
      - name: Build & Push Backend Image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/backend:latest
          platforms: linux/amd64,linux/arm64

      # Build & Push Frontend Image
      - name: Build & Push Frontend Image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/frontend:latest
          platforms: linux/amd64,linux/arm64


  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:

      # Checkout repo
      - uses: actions/checkout@v3

      # Azure Login
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Obtener credenciales del AKS
      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group rg-aks-project \
            --name knaval-aks \
            --overwrite-existing

      # Aplicar todos los manifiestos del proyecto
      - name: Apply Backend / Frontend / Database / Ingress
        run: |
          kubectl apply -f k8s/backend/
          kubectl apply -f k8s/frontend/
          kubectl apply -f k8s/database/
          kubectl apply -f k8s/ingress/
 
      # MONITORIZACIÓN (Prometheus + Grafana) — OPCIONAL
      # Descomentar si quieres desplegar el stack también aquí.
      #
      # - name: Apply Monitoring (Optional)
      #   run: |
      #     kubectl apply -f k8s/monitoring/

      # Esperar a que los deployments arranquen correctamente
      - name: Wait for Deployments
        run: |
          kubectl rollout status deployment/backend-deployment -n knaval --timeout=90s
          kubectl rollout status deployment/frontend-deployment -n knaval --timeout=90s