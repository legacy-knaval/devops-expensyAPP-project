name: CI/CD AKS Deployment

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  ACR_NAME: kennyacr1
  ACR_LOGIN_SERVER: kennyacr1.azurecr.io

jobs:

  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR Login
        run: |
          az acr login --name $ACR_NAME

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build & Push Backend Image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/backend:latest
          platforms: linux/amd64,linux/arm64

      - name: Build & Push Frontend Image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/frontend:latest
          platforms: linux/amd64,linux/arm64


  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group rg-aks-project \
            --name knaval-aks \
            --overwrite-existing

      - name: Apply Backend / Frontend / DB / Ingress
        run: |
          kubectl apply -f k8s/backend/
          kubectl apply -f k8s/frontend/
          kubectl apply -f k8s/database/
          kubectl apply -f k8s/ingress/

      # ------------ OPTIONAL: Monitoring Stack ------------
      # - name: Apply Monitoring (Optional)
      #   run: |
      #     kubectl apply -f k8s/monitoring/
      # ----------------------------------------------------

      - name: Force restart deployments to pull new images
        run: |
          kubectl rollout restart deployment/backend-deployment -n knaval
          kubectl rollout restart deployment/frontend-deployment -n knaval
          kubectl rollout status deployment/backend-deployment -n knaval --timeout=90s
          kubectl rollout status deployment/frontend-deployment -n knaval --timeout=90s